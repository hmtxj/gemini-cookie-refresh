name: 自动注册新账号 (Windows)

on:
  workflow_dispatch:
    inputs:
      count:
        description: '注册数量'
        required: true
        default: '1'
      
jobs:
  register:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: 安装 Chrome
        uses: browser-actions/setup-chrome@v1
      
      - name: 安装依赖
        run: pip install DrissionPage requests pyyaml
      
      - name: 恢复 Clash 配置
        env:
          CLASH_CONFIG: ${{ secrets.CLASH_CONFIG }}
        shell: pwsh
        run: |
          $env:CLASH_CONFIG | Out-File -FilePath local.yaml -Encoding utf8 -NoNewline
          
      - name: 下载 Clash (Mihomo)
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-windows-amd64-v1.18.10.zip" -OutFile mihomo.zip
          Expand-Archive mihomo.zip -DestinationPath . -Force
          Move-Item mihomo-windows-amd64.exe clash.exe -Force
          
      - name: 运行注册机
        env:
          PYTHONIOENCODING: utf-8
        run: |
          # 循环运行脚本
          python register_account.py --count ${{ inputs.count }}
          
      - name: 上传新账号到 Secret
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        shell: pwsh
        run: |
          if (Test-Path accounts.json) {
              # 读取现有 Secret
              # 注意：这里需要合并逻辑，简化起见，直接覆盖或追加比较复杂
              # 建议让 register_account.py 读取现有 Secret (通过 env) 并合并后输出
              
              # 简单方案：只上传 Artifact，手动合并
              Write-Host "账号已生成，请检查 Artifacts"
          }
          
      - name: 上传结果 Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: registered-accounts
          path: |
            result.csv
            accounts.json
            register_log.txt
