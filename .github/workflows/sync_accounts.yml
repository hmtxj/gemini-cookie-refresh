name: 同步账号到数据库

on:
  # 定时执行：已停用 (集成到刷新脚本中)
  # schedule:
  #   - cron: '0 */11 * * *'
  # 手动触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装依赖
        run: pip install psycopg2-binary requests
      
      - name: 从 Secret 恢复 accounts.json
        env:
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}
        run: |
          printf '%s' "$ACCOUNTS_JSON" > accounts.json
          echo "账号数量: $(grep -o '"id"' accounts.json | wc -l)"
      
      - name: 同步到数据库并触发热重载
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          HF_SPACE_URL: ${{ secrets.HF_SPACE_URL }}
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
        run: python sync_to_db.py
