name: åˆ·æ–° Gemini Business Cookie (Windows)

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæµ‹è¯•ç”¨ï¼‰
  workflow_dispatch:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯ 10 å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆå–æ¶ˆæ³¨é‡Šåå¯ç”¨ï¼‰
  # schedule:
  #   - cron: '0 */10 * * *'

jobs:
  refresh:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£… Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install DrissionPage requests huggingface_hub psycopg2-binary pyyaml
          chrome --version
      
      - name: è®¾ç½®ä»£ç†å¹¶è¿è¡Œåˆ·æ–°è„šæœ¬
        env:
          CLASH_CONFIG: ${{ secrets.CLASH_CONFIG }}
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROXY_URL: http://127.0.0.1:7890
        shell: pwsh
        run: |
          # ========== 1. ä¸‹è½½ä»£ç† ==========
          Write-Host "ğŸ“¦ ä¸‹è½½ mihomo (Clash Meta) Windows ç‰ˆ..."
          
          $url = "https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-windows-amd64-v1.18.10.zip"
          $fallbackUrl = "https://mirror.ghproxy.com/https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-windows-amd64-v1.18.10.zip"
          
          try {
            Invoke-WebRequest -Uri $url -OutFile "mihomo.zip" -TimeoutSec 60
          } catch {
            Write-Host "ä¸»æºä¸‹è½½å¤±è´¥ï¼Œå°è¯•é•œåƒ..."
            Invoke-WebRequest -Uri $fallbackUrl -OutFile "mihomo.zip" -TimeoutSec 60
          }
          
          Expand-Archive -Path "mihomo.zip" -DestinationPath "." -Force
          Rename-Item -Path "mihomo-windows-amd64.exe" -NewName "mihomo.exe" -ErrorAction SilentlyContinue
          
          # ========== 2. é…ç½®ä»£ç† ==========
          Write-Host "ğŸ“ ä» Secret æ¢å¤ Clash é…ç½®..."
          $env:CLASH_CONFIG | Out-File -FilePath "local.yaml" -Encoding utf8
          
          Write-Host "ğŸ“ ä¿®æ”¹é…ç½®..."
          python update_clash_config.py local.yaml
          
          # ========== 3. å¯åŠ¨ä»£ç†ï¼ˆä¿æŒåå°è¿è¡Œï¼‰ ==========
          Write-Host "ğŸš€ å¯åŠ¨ä»£ç†..."
          $proxyProcess = Start-Process -FilePath ".\mihomo.exe" -ArgumentList "-f", "local.yaml" -PassThru -NoNewWindow
          Write-Host "Mihomo PID: $($proxyProcess.Id)"
          Start-Sleep -Seconds 10
          
          # ========== 4. éªŒè¯ä»£ç† ==========
          Write-Host ""
          Write-Host "ğŸ” éªŒè¯ä»£ç†..."
          Write-Host "ğŸ“ GitHub Actions åŸå§‹ IP:"
          try {
            (Invoke-WebRequest -Uri "https://api.ipify.org" -TimeoutSec 10).Content
          } catch { Write-Host "è·å–å¤±è´¥" }
          
          Write-Host ""
          Write-Host "ğŸ“ é€šè¿‡ä»£ç†çš„ IP:"
          try {
            (Invoke-WebRequest -Uri "https://api.ipify.org" -Proxy "http://127.0.0.1:7890" -TimeoutSec 15).Content
          } catch { Write-Host "ä»£ç†è¿æ¥å¤±è´¥: $_" }
          
          Write-Host ""
          Write-Host "ğŸ“ é€šè¿‡ä»£ç†è®¿é—® Google:"
          try {
            $resp = Invoke-WebRequest -Uri "https://www.google.com" -Proxy "http://127.0.0.1:7890" -TimeoutSec 15
            Write-Host "HTTP $($resp.StatusCode)"
          } catch { Write-Host "å¤±è´¥: $_" }
          
          # ========== 5. æ¢å¤ accounts.json ==========
          Write-Host ""
          Write-Host "ğŸ“¦ æ¢å¤ accounts.json..."
          $env:ACCOUNTS_JSON | Out-File -FilePath "accounts.json" -Encoding utf8
          $size = (Get-Item "accounts.json").Length
          Write-Host "accounts.json å†…å®¹é•¿åº¦: $size å­—èŠ‚"
          
          # ========== 6. è¿è¡Œåˆ·æ–°è„šæœ¬ ==========
          Write-Host ""
          Write-Host "ğŸš€ è¿è¡Œåˆ·æ–°è„šæœ¬..."
          python refresh_accounts.py --force
          
          # ========== 7. åœæ­¢ä»£ç† ==========
          Write-Host ""
          Write-Host "ğŸ›‘ åœæ­¢ä»£ç†..."
          if ($proxyProcess -and !$proxyProcess.HasExited) {
            $proxyProcess.Kill()
            Write-Host "ä»£ç†å·²åœæ­¢"
          }
      
      - name: ä¸Šä¼ è°ƒè¯•æˆªå›¾
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-windows
          path: screenshots/
          if-no-files-found: ignore
      
      - name: æ›´æ–° Secret ä¸­çš„ accounts.json
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        shell: pwsh
        run: |
          Get-Content "accounts.json" | gh secret set ACCOUNTS_JSON
