name: åˆ·æ–° Gemini Business Cookieï¼ˆWindowsï¼‰

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å®šæ—¶æ‰§è¡Œï¼šæ¯ 10 å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */10 * * *'
  

jobs:
  refresh:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£… Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install DrissionPage requests huggingface_hub psycopg2-binary pyyaml
          chrome --version 2>$null || echo "Chrome installed via action"
      
      # ä» Secret æ¢å¤ Clash é…ç½®å¹¶å¯åŠ¨ä»£ç†ï¼Œç„¶ååœ¨åŒä¸€ Step ä¸­è¿è¡Œè„šæœ¬
      - name: å¯åŠ¨ä»£ç†å¹¶è¿è¡Œè„šæœ¬ (åˆå¹¶æ­¥éª¤)
        env:
          CLASH_CONFIG: ${{ secrets.CLASH_CONFIG }}
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
          HF_SPACE_URL: ${{ secrets.HF_SPACE_URL }}
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROXY_URL: http://127.0.0.1:7890
          PYTHONIOENCODING: utf-8
        shell: pwsh
        run: |
          # === 1. ç¯å¢ƒå‡†å¤‡ ===
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:DISPLAY = ":99"  # è™½ç„¶ Windows ä¸ç”¨ Xvfbï¼Œä½†ä¹Ÿè®¾ç½®ä¸€ä¸‹é˜²å¹²æ‰°

          # === 2. æ¢å¤ accounts.json ===
          Write-Host "ğŸ“‚ æ¢å¤ accounts.json..."
          $env:ACCOUNTS_JSON | Out-File -FilePath accounts.json -Encoding utf8 -NoNewline
          $size = (Get-Item accounts.json).Length
          Write-Host "   å·²æ¢å¤ ($size å­—èŠ‚)"

          # === 3. ä¸‹è½½å¹¶é…ç½® Clash ===
          Write-Host "ğŸ“¦ ä¸‹è½½ mihomo (Clash Meta)..."
          $url = "https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-windows-amd64-v1.18.10.zip"
          $mirrorUrl = "https://mirror.ghproxy.com/$url"
          try {
              Invoke-WebRequest -Uri $url -OutFile mihomo.zip -TimeoutSec 60
          } catch {
              Write-Host "   ä½¿ç”¨é•œåƒä¸‹è½½..."
              Invoke-WebRequest -Uri $mirrorUrl -OutFile mihomo.zip -TimeoutSec 60
          }
          Expand-Archive -Path mihomo.zip -DestinationPath . -Force
          Move-Item -Path "mihomo-windows-amd64.exe" -Destination "mihomo.exe" -Force
          
          Write-Host "ğŸ“ é…ç½® Clash..."
          $env:CLASH_CONFIG | Out-File -FilePath local.yaml -Encoding utf8 -NoNewline
          python update_clash_config.py local.yaml
          
          # === 4. å¯åŠ¨ä»£ç† ===
          Write-Host "ğŸš€ å¯åŠ¨ä»£ç†è¿›ç¨‹..."
          Start-Process -FilePath ".\mihomo.exe" -ArgumentList "-f", "local.yaml" -RedirectStandardOutput "clash.log" -RedirectStandardError "clash_err.log" -NoNewWindow
          
          Write-Host "â³ ç­‰å¾…ä»£ç†ç«¯å£ (7890)..."
          $retry = 0
          while ($retry -lt 30) {
              $conn = Test-NetConnection -ComputerName 127.0.0.1 -Port 7890 -InformationLevel Quiet
              if ($conn) {
                  Write-Host "âœ… ç«¯å£å·²å¼€æ”¾"
                  break
              }
              Start-Sleep -Seconds 1
              $retry++
          }
          if (-not $conn) {
              Write-Host "âŒ ä»£ç†å¯åŠ¨è¶…æ—¶"
              Get-Content clash_err.log
              exit 1
          }

          # === 5. éªŒè¯ä»£ç† ===
          Write-Host "ğŸ” éªŒè¯ä»£ç†è¿é€šæ€§..."
          try {
              $ip = (Invoke-WebRequest -Uri "https://api.ipify.org" -Proxy "http://127.0.0.1:7890" -TimeoutSec 10).Content
              Write-Host "   IP: $ip"
          } catch {
              Write-Host "   âš ï¸ ä»£ç†éªŒè¯è¯·æ±‚å¤±è´¥ (å¯èƒ½æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼Œç»§ç»­å°è¯•è¿è¡Œè„šæœ¬)"
          }

          # === 6. è¿è¡Œ Python è„šæœ¬ ===
          Write-Host "ğŸ è¿è¡Œåˆ·æ–°è„šæœ¬..."
          python refresh_accounts.py --force
      
      - name: ä¸Šä¼ è°ƒè¯•æˆªå›¾
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-windows
          path: screenshots/
          if-no-files-found: ignore
      
      - name: æ›´æ–° Secret ä¸­çš„ accounts.json
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        shell: pwsh
        run: |
          Get-Content accounts.json | gh secret set ACCOUNTS_JSON
