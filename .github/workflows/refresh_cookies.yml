name: åˆ·æ–° Gemini Business Cookie

on:
  # å®šæ—¶æ‰§è¡Œï¼šå·²åœç”¨ (æ”¹ç”¨ Windows)
  # schedule:
  #   - cron: '0 */10 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£… Chrome å’Œ Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: å®‰è£… Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install DrissionPage requests huggingface_hub psycopg2-binary pyyaml
          google-chrome --version || echo "Chrome not found"
      
      # ä»Ž Secret æ¢å¤ Clash é…ç½®å¹¶å¯åŠ¨ä»£ç†
      - name: è®¾ç½®ä»£ç†
        env:
          CLASH_CONFIG: ${{ secrets.CLASH_CONFIG }}
        run: |
          echo "ðŸ“¦ ä¸‹è½½ mihomo (Clash Meta)..."
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-linux-amd64-v1.18.10.gz -O mihomo.gz || \
          wget -q https://mirror.ghproxy.com/https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-linux-amd64-v1.18.10.gz -O mihomo.gz
          gunzip mihomo.gz
          chmod +x mihomo
          
          echo "ðŸ“ ä»Ž Secret æ¢å¤ Clash é…ç½®..."
          printf '%s' "$CLASH_CONFIG" > local.yaml
          
          echo "ðŸ“ é…ç½®æ–‡ä»¶å†…å®¹ï¼ˆè„±æ•ï¼‰:"
          head -30 local.yaml | sed 's/password:.*/password: ***/' | sed 's/uuid:.*/uuid: ***/'
          
          echo ""
          echo "ðŸ“ ä¿®æ”¹é…ç½®..."
          python3 update_clash_config.py local.yaml
          
          echo ""
          echo "ðŸš€ å¯åŠ¨ä»£ç†..."
          ./mihomo -f local.yaml > clash.log 2>&1 &
          MIHOMO_PID=$!
          echo "Mihomo PID: $MIHOMO_PID"
          sleep 8
          
          echo ""
          echo "ðŸ“‹ Clash å¯åŠ¨æ—¥å¿—:"
          cat clash.log
          
          echo ""
          echo "ðŸ” éªŒè¯ä»£ç†..."
          echo "ðŸ“ GitHub Actions åŽŸå§‹ IP (ä¸èµ°ä»£ç†):"
          curl -s https://api.ipify.org && echo ""
          
          echo ""
          echo "ðŸ“ é€šè¿‡ä»£ç†çš„ IP (ä»£ç†èŠ‚ç‚¹):"
          curl -s --proxy http://127.0.0.1:7890 --connect-timeout 15 https://api.ipify.org && echo "" || echo "ä»£ç†è¿žæŽ¥å¤±è´¥"
          
          echo ""
          echo "ðŸ“ é€šè¿‡ä»£ç†è®¿é—® Google:"
          curl -s --proxy http://127.0.0.1:7890 --connect-timeout 15 -o /dev/null -w "HTTP %{http_code}" https://www.google.com && echo "" || echo "å¤±è´¥"
      
      - name: ä»Ž Secret æ¢å¤ accounts.json
        env:
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}
        run: |
          printf '%s' "$ACCOUNTS_JSON" > accounts.json
          echo "accounts.json å†…å®¹é•¿åº¦: $(wc -c < accounts.json) å­—èŠ‚"
      
      - name: è¿è¡Œåˆ·æ–°è„šæœ¬
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROXY_URL: http://127.0.0.1:7890
          DISPLAY: ":99"
        run: |
          # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨
          echo "ðŸ–¥ï¸ å¯åŠ¨ Xvfb è™šæ‹Ÿæ˜¾ç¤ºå™¨..."
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          # è¿è¡Œè„šæœ¬
          python refresh_accounts.py --force
      
      - name: ä¸Šä¼ è°ƒè¯•æˆªå›¾
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/
          if-no-files-found: ignore
      
      - name: æ›´æ–° Secret ä¸­çš„ accounts.json
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh secret set ACCOUNTS_JSON < accounts.json
