name: åˆ·æ–° Gemini Business Cookie

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯ 10 å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */10 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install playwright requests huggingface_hub psycopg2-binary pyyaml
          playwright install chromium
      
      # ä¸‹è½½å¹¶å¯åŠ¨ä»£ç†
      - name: è®¾ç½®ä»£ç†
        env:
          SUBSCRIBE_URL: ${{ secrets.SUBSCRIBE_URL }}
        run: |
          echo "ğŸ“¦ ä¸‹è½½ Clash..."
          wget -q https://github.com/Dreamacro/clash/releases/download/v1.18.0/clash-linux-amd64-v1.18.0.gz
          gunzip clash-linux-amd64-v1.18.0.gz
          chmod +x clash-linux-amd64-v1.18.0
          mv clash-linux-amd64-v1.18.0 clash
          
          echo "ğŸ“¥ ä¸‹è½½è®¢é˜…é…ç½®..."
          curl -s -o config.yaml "$SUBSCRIBE_URL"
          
          # ä¿®æ”¹é…ç½®ï¼šè®¾ç½®ç«¯å£å’Œæ¨¡å¼
          python3 - <<'EOF'
import yaml
with open('config.yaml', 'r') as f:
    config = yaml.safe_load(f)
config['mixed-port'] = 7890
config['allow-lan'] = True
config['mode'] = 'global'
config['external-controller'] = '127.0.0.1:9090'
with open('config.yaml', 'w') as f:
    yaml.dump(config, f, allow_unicode=True)
print("âœ… é…ç½®å·²æ›´æ–°")
EOF
          
          echo "ğŸš€ å¯åŠ¨ Clash..."
          nohup ./clash -f config.yaml > clash.log 2>&1 &
          sleep 5
          
          # éªŒè¯ä»£ç†å¯ç”¨
          if curl -s --proxy http://127.0.0.1:7890 --connect-timeout 10 https://www.google.com > /dev/null; then
            echo "âœ… ä»£ç†å¯ç”¨"
          else
            echo "âŒ ä»£ç†ä¸å¯ç”¨ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
            cat clash.log
            exit 1
          fi
      
      - name: ä» Secret æ¢å¤ accounts.json
        env:
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}
        run: |
          printf '%s' "$ACCOUNTS_JSON" > accounts.json
          echo "accounts.json å†…å®¹é•¿åº¦: $(wc -c < accounts.json) å­—èŠ‚"
      
      - name: è¿è¡Œåˆ·æ–°è„šæœ¬
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROXY_URL: http://127.0.0.1:7890
        run: |
          python refresh_accounts.py --force
      
      - name: ä¸Šä¼ è°ƒè¯•æˆªå›¾
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/
          if-no-files-found: ignore
      
      - name: æ›´æ–° Secret ä¸­çš„ accounts.json
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh secret set ACCOUNTS_JSON < accounts.json
